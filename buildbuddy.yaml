actions:
  - name: "Build"
    triggers:
      push:
        branches:
          - "main"
      pull_request:
        branches:
          - "*"
    steps:
      - run: |
          BAZEL_LLVM_PATH=/toolchain bazel build \
            --config=ci \
            --config=buildbuddy \
            -c opt \
            //:envoy.stripped

  - name: "Test (coverage)"
    triggers:
      push:
        branches:
          - "main"
      pull_request:
        branches:
          - "*"
    steps:
      - run: |
          BAZEL_LLVM_PATH=/toolchain bazel coverage \
            --config=ci \
            --config=buildbuddy \
            --nocache_test_results \
            //test/...

  - name: "Test (asan)"
    container_image: "docker.io/joekralicky/envoy-build@sha256:8e4d6b4c4f9567f5226208573d764992c0fad097144fce3879ab9e53fe3f4d57"
    triggers:
      push:
        branches:
          - "main"
      pull_request:
        branches:
          - "*"
    steps:
      - run: |
          BAZEL_LLVM_PATH=/toolchain bazelisk test \
            --config=ci \
            --config=buildbuddy \
            --config=asan \
            -c dbg \
            //test/...

  - name: "Test (msan)"
    container_image: "docker.io/joekralicky/envoy-build@sha256:8e4d6b4c4f9567f5226208573d764992c0fad097144fce3879ab9e53fe3f4d57"
    triggers:
      push:
        branches:
          - "main"
      pull_request:
        branches:
          - "*"
    steps:
      - run: |
          BAZEL_LLVM_PATH=/toolchain bazelisk test \
            --config=ci \
            --config=buildbuddy \
            --config=msan \
            -c dbg \
            //test/...

  - name: "Test (tsan)"
    container_image: "docker.io/joekralicky/envoy-build@sha256:8e4d6b4c4f9567f5226208573d764992c0fad097144fce3879ab9e53fe3f4d57"
    triggers:
      push:
        branches:
          - "main"
      pull_request:
        branches:
          - "*"
    steps:
      - run: |
          BAZEL_LLVM_PATH=/toolchain bazelisk test \
            --config=ci \
            --config=buildbuddy \
            --config=tsan \
            -c dbg \
            //test/...
